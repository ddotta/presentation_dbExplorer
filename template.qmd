---
title: "Le package dbExplorer"
subtitle: "Un outil Shiny pour explorer les bases de données et les tables parquet"
date: today
date-format: "DD/MM/YYYY"
author: "SSP/DEMESIS/BQIS/PAOS"
description: |
  Présentation du package dbExplorer au GUR du 30 juin 2025

slide-tone: false # for blind readers
chalkboard: false # press the B key to toggle chalkboard
transition: slide
fig-cap-location: bottom
self-contained: true

toc: true
toc-title: Sommaire
toc-depth: 1
toc-float: true

# multiplex: true
execute:
  echo: false
  warning: false
  cache: false
editor:
  render-on-save: true
---

## A quoi sert le package dbExplorer ?

Un package R qui lance une application Shiny qui a **Plusieurs objectifs :**

- Explorer rapidement les données présentes dans une base de données
- Explorer rapidement le contenu des tables au format Parquet sur Cerise
- Faire des manipulations de 1er niveau sur ces données

=> Un package développé et maintenu par Adam Marsal du SSM Justice.

  
## Installation du package depuis Cerise


```{.r}
# install.packages("remotes")
remotes::install_git("https://gitlab.forge.agriculture.rie.gouv.fr/ssp/bmis/packages/dbexplorer",
                     dependencies = T,
                     git = "external")
```

Comme n'importe quel autre package R, `{dbExplorer}` doit être chargé avec :


```{.r}
library(dbExplorer)
```

Avant d'explorer ce package, 2 concepts théoriques sont nécessaires.

## Les "Background jobs" de RStudio

Les "Background Jobs" dans RStudio sont une fonctionnalité qui permet **d’exécuter des scripts R en arrière-plan** sans bloquer l’interface principale de RStudio. 

![](img/Background_jobs.png){fig-align="center"} <br>
**Quelques caractéristiques** :  

- **Une exécution indépendante** : le job s'exécute dans un processus séparé de la session principale (non bloquant).  
- **Suivi de l'exécution** : une fenêtre dédiée dans RStudio qui permet de consulter la progression, les messages et l'état du job (traçabilité).
- **Une reproductibilité garantie** : les jobs relancent le script tel qu'il est au moment de l'appel dans un environnement propre. Le job s'exécute de manière isolé sans polluer l'environnement global.

## Exemple de Background jobs (1/3)

Soit le script simple suivant :  

```{.r}
library(dplyr)

Sys.sleep(5)
tab_agregee <- iris |> 
  summarise(Moy_pet_long = mean(Petal.Length, na.rm = TRUE), .by = Species)
Sys.sleep(5)

print("Pgm terminé")
```
<br>

Ce script peut être lancé via un background job en cliquant sur le bouton `"Start Background job"`.    

## Exemple de Background jobs (2/3)

La fenêtre suivante s'affiche :  

![](img/fenetre_background_jobs.png){fig-align="center"}
## Exemple de Background jobs (3/3)

En fonction des choix effectués au lancement du background job, les résultats seront (ou pas) disponibles dans l'environnement global de la session R.  

![](img/Env_background_jobs.png){fig-align="center"}

Si vous avez choisi de stocker les résultats dans un objet "results", voici comment y accéder :  

![](img/get_env_background_jobs.png){fig-align="center"}

## Structure d'une base de données relationnelles

Les bases de données relationnelles sont structurées **de manière hiérarchique et logique**.  

- **La Base de donnée (BDD)** : c'est l'entité principale qui contient l'ensemble des données
- **Le schéma** : c'est une structure logique à l'intérieur d'une BDD. Il sert à organiser les objets. Il peut être vu comme un *dossier* dans la BDD
- **Les tables** : ce sont les éléments centraux où les données sont stockées
- **Les vues** : ce sont des représentations virtuelles de tables (créées au moment des requêtes)

Exemple de structure :  

```
Base de données : vente_en_ligne
│
├── Schéma : public
│   ├── Table : clients
│   ├── Table : commandes
│   └── Table : produits
│
└── Schéma : archive
    └── Table : commandes_2020
```

## Se connecter à une BDD sans dbExplorer (1/2)

Exemple avec BDD PostgreSQL :  

```{r}
library(connections)
library(RPostgres)

### Chargement des infos de connection
infos_connection_prod <- read_delim("infos_connection.csv", 
                                    delim = ";", escape_double = FALSE, trim_ws = TRUE,
                                    show_col_types = FALSE) %>% 
  filter(ENV == "PROD")

### Connexion à la BDD
con <- connection_open(Postgres(), user = infos_connection_prod[["USER"]],password = rawToChar(openssl::base64_decode(infos_connection_prod[["PWD"]])),host = infos_connection_prod[["DB_URL"]], dbname = infos_connection_prod[["DATABASE"]],port = infos_connection_prod[["PORT"]])
```

=> La structure de la BDD est visible dans l'onglet `"Connections"` de RStudio :  

![](img/balsaV2.png){fig-align="center"}

## Se connecter à une BDD sans dbExplorer (2/2)

![](img/balsaV2_resultat.png){fig-align="center"}


## Explorer une base de données (1/N)

```{.r}
## Création du fichier de connexion à postgre SQL 
connector_file <- "./R/dbExplorer-connector/dbExplorerPgConnector.R"
dbExplorer:::createPostgreSQLConnector(host = "postgresql-164525.projet-sortie-sas",
                                       dbname = "dvf",
                                       port = 5432,
                                       file=connector_file)
```

```{.r}
## Lancement de l'application sur ce fichier de connexion. 
ExplorerDonnees(connectorFile = connector_file)
```

Puis entrer le login & mot de passe d'accès à la BDD.
 

=> **Un "background job"** se lance dans RStudio et **une application shiny** s'ouvre dans le navigateur.

## Création de fichiers parquet à partir d'une BDD

TO DO


## Explorer des fichiers parquets

```{.r}
dbExplorer::ExplorerDossiers("~/CERISE/03-Espace-de-Diffusion/030_Structures_exploitations/3020_Recensements/RA_2010/")
```

## Pour en savoir plus

- [Fiche utilitr](https://book.utilitr.org/03_Fiches_thematiques/Fiche_connexion_bdd.html) sur l'utilisation des bases de données avec R.